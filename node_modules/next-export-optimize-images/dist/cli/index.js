"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _export(target,all){for(var name in all)Object.defineProperty(target,name,{enumerable:true,get:all[name]})}_export(exports,{getOptimizeResult:function(){return getOptimizeResult},optimizeImages:function(){return optimizeImages},run:function(){return run}});var _crypto=require("crypto");var _path=_interopRequireDefault(require("path"));var _ansiColors=_interopRequireDefault(require("ansi-colors"));var _fsExtra=_interopRequireDefault(require("fs-extra"));var _sharp=_interopRequireDefault(require("sharp"));var _getConfig=_interopRequireDefault(require("../utils/getConfig"));var _processManifest=_interopRequireDefault(require("../utils/processManifest"));var _externalImages=_interopRequireDefault(require("./external-images"));var _cache=require("./utils/cache");var _cliProgressBar=require("./utils/cliProgressBar");var _formatValidate=_interopRequireDefault(require("./utils/formatValidate"));var _uniqueItems=_interopRequireDefault(require("./utils/uniqueItems"));function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==="function"){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable}))}ownKeys.forEach(function(key){_defineProperty(target,key,source[key])})}return target}var __generator=(void 0)&&(void 0).__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};var getOptimizeResult=function(){var _ref=_asyncToGenerator(function(param){var destDir,noCache,cacheImages,cacheDir,cacheMeasurement,nonCacheMeasurement,errorMeasurement,pushInvalidFormatAssets,cliProgressBarIncrement,originalFilePath,output,width,quality,extension,sharpOptions,filePath,outputPath,imageBuffer,cacheImagesFindIndex,hash,currentCacheImage,image,error,filePath1,error1;return __generator(this,function(_state){switch(_state.label){case 0:destDir=param.destDir,noCache=param.noCache,cacheImages=param.cacheImages,cacheDir=param.cacheDir,cacheMeasurement=param.cacheMeasurement,nonCacheMeasurement=param.nonCacheMeasurement,errorMeasurement=param.errorMeasurement,pushInvalidFormatAssets=param.pushInvalidFormatAssets,cliProgressBarIncrement=param.cliProgressBarIncrement,originalFilePath=param.originalFilePath,output=param.output,width=param.width,quality=param.quality,extension=param.extension,sharpOptions=param.sharpOptions;if(!(0,_formatValidate.default)(extension))return[3,23];_state.label=1;case 1:_state.trys.push([1,21,,22]);filePath=_path.default.join(destDir,output);return[4,_fsExtra.default.ensureFile(filePath)];case 2:_state.sent();outputPath=_path.default.join(cacheDir,output);return[4,_fsExtra.default.ensureFile(outputPath)];case 3:_state.sent();return[4,_fsExtra.default.readFile(originalFilePath)];case 4:imageBuffer=_state.sent();if(!!noCache)return[3,8];cacheImagesFindIndex=cacheImages.findIndex(function(cacheImage){return cacheImage.output===output});hash=(0,_crypto.createHash)("sha256").update(imageBuffer).digest("hex");if(!(cacheImagesFindIndex===-1))return[3,5];cacheImages.push({output:output,hash:hash});return[3,8];case 5:currentCacheImage=cacheImages[cacheImagesFindIndex];if(!((currentCacheImage===null||currentCacheImage===void 0?void 0:currentCacheImage.hash)===hash))return[3,7];return[4,_fsExtra.default.copy(outputPath,filePath)];case 6:_state.sent();cacheMeasurement();cliProgressBarIncrement();return[2];case 7:if(currentCacheImage!==undefined)currentCacheImage.hash=hash;_state.label=8;case 8:image=(0,_sharp.default)(imageBuffer,{sequentialRead:true});image.rotate().resize({width:width,withoutEnlargement:true});switch(extension){case"jpeg":return[3,9];case"jpg":return[3,11];case"png":return[3,13];case"webp":return[3,15];case"avif":return[3,17]}return[3,19];case 9:return[4,image.jpeg(_objectSpread({quality:quality},sharpOptions===null||sharpOptions===void 0?void 0:sharpOptions.jpg)).toFile(outputPath)];case 10:_state.sent();return[3,19];case 11:return[4,image.jpeg(_objectSpread({quality:quality},sharpOptions===null||sharpOptions===void 0?void 0:sharpOptions.jpg)).toFile(outputPath)];case 12:_state.sent();return[3,19];case 13:return[4,image.png(_objectSpread({quality:quality},sharpOptions===null||sharpOptions===void 0?void 0:sharpOptions.png)).toFile(outputPath)];case 14:_state.sent();return[3,19];case 15:return[4,image.webp(_objectSpread({quality:quality},sharpOptions===null||sharpOptions===void 0?void 0:sharpOptions.webp)).toFile(outputPath)];case 16:_state.sent();return[3,19];case 17:return[4,image.avif(_objectSpread({quality:quality},sharpOptions===null||sharpOptions===void 0?void 0:sharpOptions.avif)).toFile(outputPath)];case 18:_state.sent();return[3,19];case 19:return[4,_fsExtra.default.copy(outputPath,filePath)];case 20:_state.sent();nonCacheMeasurement();cliProgressBarIncrement();return[3,22];case 21:error=_state.sent();console.warn(error);cliProgressBarIncrement();errorMeasurement();return[3,22];case 22:return[3,27];case 23:_state.trys.push([23,26,,27]);filePath1=_path.default.join(destDir,output);return[4,_fsExtra.default.ensureFile(filePath1)];case 24:_state.sent();return[4,_fsExtra.default.copy(originalFilePath,filePath1)];case 25:_state.sent();pushInvalidFormatAssets(originalFilePath);cliProgressBarIncrement();return[3,27];case 26:error1=_state.sent();console.warn(error1);cliProgressBarIncrement();errorMeasurement();return[3,27];case 27:return[2]}})});return function getOptimizeResult(_){return _ref.apply(this,arguments)}}();var cwd=process.cwd();var optimizeImages=function(){var _ref=_asyncToGenerator(function(param){var manifestJsonPath,noCache,config,_terse,terse,_outDir,destDir,manifest,error,cacheImages,promises,measuredCache,measuredNonCache,measuredError,invalidFormatAssets,cacheMeasurement,nonCacheMeasurement,errorMeasurement,pushInvalidFormatAssets,_iteratorNormalCompletion,_didIteratorError,_iteratorError,_iterator,_step,item,originalFilePath,_sharpOptions;return __generator(this,function(_state){switch(_state.label){case 0:manifestJsonPath=param.manifestJsonPath,noCache=param.noCache,config=param.config,_terse=param.terse,terse=_terse===void 0?false:_terse;destDir=_path.default.resolve(cwd,(_outDir=config.outDir)!==null&&_outDir!==void 0?_outDir:"out");_state.label=1;case 1:_state.trys.push([1,3,,4]);return[4,_fsExtra.default.readFile(manifestJsonPath,"utf-8")];case 2:manifest=_uniqueItems.default.apply(void 0,[_processManifest.default.apply(void 0,[_state.sent()])]);return[3,4];case 3:error=_state.sent();throw Error(typeof error==="string"?error:"Unexpected error.");case 4:if(!manifest.some(function(param){var externalUrl=param.externalUrl;return externalUrl!==undefined}))return[3,6];return[4,(0,_externalImages.default)({terse:terse,manifest:manifest,destDir:destDir})];case 5:_state.sent();_state.label=6;case 6:if(!terse){console.log("\n- Image Optimization -");(0,_cliProgressBar.cliProgressBarStart)(manifest.length)}cacheImages=[];if(!!noCache)return[3,8];return[4,(0,_cache.createCacheDir)()];case 7:_state.sent();cacheImages=(0,_cache.readCacheManifest)();_state.label=8;case 8:promises=[];measuredCache=0;measuredNonCache=0;measuredError=0;invalidFormatAssets=new Set([]);cacheMeasurement=function(){return measuredCache+=1};nonCacheMeasurement=function(){return measuredNonCache+=1};errorMeasurement=function(){return measuredError+=1};pushInvalidFormatAssets=function(asset){return invalidFormatAssets.add(asset)};_iteratorNormalCompletion=true,_didIteratorError=false,_iteratorError=undefined;try{for(_iterator=manifest[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){item=_step.value;originalFilePath=_path.default.join(destDir,item.src);promises.push(getOptimizeResult(_objectSpread({destDir:destDir,noCache:noCache,cacheImages:cacheImages,cacheDir:_cache.defaultCacheDir,cacheMeasurement:cacheMeasurement,nonCacheMeasurement:nonCacheMeasurement,errorMeasurement:errorMeasurement,pushInvalidFormatAssets:pushInvalidFormatAssets,cliProgressBarIncrement:terse?function(){return undefined}:_cliProgressBar.cliProgressBarIncrement,originalFilePath:originalFilePath,sharpOptions:(_sharpOptions=config.sharpOptions)!==null&&_sharpOptions!==void 0?_sharpOptions:{}},item)))}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return!=null){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}return[4,Promise.all(promises)];case 9:_state.sent();if(!noCache){(0,_cache.writeCacheManifest)(cacheImages)}if(!terse){console.log("Cache assets: ".concat(measuredCache,", NonCache assets: ").concat(measuredNonCache,", Error assets: ").concat(measuredError));if(invalidFormatAssets.size!==0){console.log("\nThe following images are in a non-optimized format and a simple copy was applied.\n",Array.from(invalidFormatAssets).join("\n"))}console.log(_ansiColors.default.bold.magenta("\nSuccessful optimization!"))}return[2]}})});return function optimizeImages(_){return _ref.apply(this,arguments)}}();var run=function(param){var customManifestJsonPath=param.customManifestJsonPath,_noCache=param.noCache,noCache=_noCache===void 0?false:_noCache;console.log(_ansiColors.default.bold.magenta("\nnext-export-optimize-images: Optimize images."));var config=(0,_getConfig.default)();var manifestJsonPath=_path.default.resolve(cwd,customManifestJsonPath!==null&&customManifestJsonPath!==void 0?customManifestJsonPath:".next/custom-optimized-images.nd.json");if(_fsExtra.default.existsSync(manifestJsonPath)){optimizeImages({manifestJsonPath:manifestJsonPath,noCache:noCache,config:config})}else{console.log(_ansiColors.default.bold.magenta("\nNo images were found to optimize.\n(Maybe you never used the image component.)"))}};